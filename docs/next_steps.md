# Next Steps — What's Done and What's Left

## Current Status

| Phase | Component | Status |
|-------|-----------|--------|
| Phase 1 | Crime MCP Server | **COMPLETE** (9/9 tests passing) |
| Phase 2 | Google Maps Helper | **COMPLETE** (adaptive waypoints + traffic) |
| Phase 3 | PydanticAI Agent | **COMPLETE** (built into safe_travels.py) |
| Phase 4 | Orchestrator | **COMPLETE** (code written, needs testing) |
| Phase 5 | FastAPI Endpoint | **NOT STARTED** |

---

## What Needs to Happen Before Everything Works

### 1. Add Your Real OpenRouter API Key

The `.env` file currently has a placeholder. Update it:

```
OPEN_ROUTER_API_KEY=your_actual_key_here
```

You can get a key at https://openrouter.ai/keys. The default model is `openai/gpt-4o-mini` which is cheap.

### 2. Run the Tests

Once the OpenRouter key is set:

```bash
# AI agent tests (Phase 3)
pytest src/tests/test_phase3_agent.py -v -s

# Orchestrator tests (Phase 4)
pytest src/tests/test_phase4_orchestrator.py -v -s

# Manual end-to-end run
python src/safe_travels.py
```

Fix any issues that come up. The mocked tests should pass without any API keys. The integration tests need Google Maps + OpenRouter keys.

### 3. Get a Private Crimeometer API Key

The shared test key (`k3RAzKN1...`) is permanently rate-limited (HTTP 429). Until you have a working private key:

- All crime data in tests is **mocked**
- The manual `python src/safe_travels.py` run will get rate-limit errors for crime data (the AI agent will still run, just with error data at each waypoint)
- Two tests in `test_phase4_orchestrator.py` are marked `@pytest.mark.skip` — remove the skip once you have a key

---

## Phase 5: FastAPI Endpoint (NOT STARTED)

This is the final phase. It wraps the orchestrator in a REST API.

### What to Build

**File:** `src/safe_travels_api.py`

**Endpoints:**

| Endpoint | Method | Description |
|----------|--------|-------------|
| `POST /analyze-route` | POST | Analyze routes between two addresses |
| `GET /health` | GET | Health check |
| `GET /docs` | GET | OpenAPI documentation (auto-generated by FastAPI) |

**Request:**
```json
{
  "start": "Willis Tower, Chicago, IL",
  "destination": "Navy Pier, Chicago, IL"
}
```

**Response:**
```json
{
  "routes": [
    {
      "route_id": 1,
      "summary": "S Lower Wacker Dr",
      "distance_miles": 2.26,
      "duration_minutes": 9,
      "start_address": "233 S Wacker Dr, Chicago, IL 60606, USA",
      "end_address": "600 E Grand Ave, Chicago, IL 60611, USA",
      "risk_score": 48,
      "analysis": "This route presents moderate risk...",
      "status": "success"
    }
  ]
}
```

### Implementation Notes

- Use Pydantic models for request/response validation
- Call `await main(start, destination)` from `src/safe_travels.py`
- Add proper error responses (400 for bad input, 500 for internal errors)
- CORS middleware if frontend will call it
- Run with `uvicorn src.safe_travels_api:app --reload --port 8000`

### Tests

**File:** `src/tests/test_phase5_api.py` (already exists, currently empty)

- Test health endpoint
- Test analyze-route with valid addresses
- Test analyze-route with invalid/empty addresses
- Test response structure matches spec

---

## Optional Improvements (After Phase 5)

These are not required but would improve the project:

### Performance
- **Cache Google Maps routes** — same start/destination within a time window returns cached routes
- **Connection pooling** — share a single `httpx.AsyncClient` across crime API calls instead of creating one per request
- **Rate limit handling** — add retry logic with exponential backoff for Crimeometer 429s

### Features
- **Multiple crime APIs** — add FBI Crime Data API (free) or CrimeScore API as fallbacks when Crimeometer is rate-limited
- **Time-of-day scoring** — adjust risk scores based on when the user plans to travel
- **Route visualization** — return waypoints + risk data for map rendering on a frontend
- **Historical comparisons** — store results and show how a route's risk changes over time

### Infrastructure
- **Containerize** — Dockerfile for the API + MCP server
- **CI/CD** — GitHub Actions to run tests on push
- **Monitoring** — track API latency, error rates, LLM costs

---

## Quick Reference: How to Run Everything

```bash
# Run the orchestrator manually (end-to-end test)
python src/safe_travels.py

# Run all tests
pytest src/tests/ -v -s

# Run specific phase tests
pytest src/tests/test_phase1_crime_mcp.py -v -s   # Phase 1 (needs MCP server running)
pytest src/tests/test_phase2_google_maps.py -v -s  # Phase 2
pytest src/tests/test_phase3_agent.py -v -s        # Phase 3
pytest src/tests/test_phase4_orchestrator.py -v -s # Phase 4

# Start the Crime MCP server (if needed for Phase 1 tests)
python -m src.MCP_Servers.crime_mcp
```
